model UserWallet {
  id         String     @id @default(cuid())
  userId     String     @map("user_id")
  user       User       @relation("UserWallets", fields: [userId], references: [id])
  walletType WalletType @default(MAIN) @map("wallet_type")
  balance    Decimal    @db.Decimal(10, 2)
  currency   String     @default("THB")
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")

  userWalletTransactions UserWalletTransaction[] @relation("UserWalletTransactions")

  @@unique([userId, walletType])
  @@map("user_wallets")
}

enum WalletType {
  MAIN
}

model UserWalletTransaction {
  id            String            @id @default(cuid())
  type          TransactionType   @default(TOPUP)
  walletId      String            @map("wallet_id")
  wallet        UserWallet        @relation("UserWalletTransactions", fields: [walletId], references: [id])
  balanceBefore Decimal           @map("balance_before") @db.Decimal(10, 2)
  balanceAfter  Decimal           @map("balance_after") @db.Decimal(10, 2)
  amount        Decimal           @db.Decimal(10, 2)
  status        TransactionStatus @default(CREATED)
  currency      String            @default("THB")
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")
  order         Order?            @relation(fields: [orderId], references: [id])
  orderId       String?           @map("order_id")

  payment          PaymentGateway? @relation(fields: [paymentGatewayId], references: [id])
  paymentGatewayId String?         @map("payment_gateway_id")

  succeededBy   User?     @relation("UserWalletTransactionSucceededBy", fields: [succeededById], references: [id])
  succeededById String?   @map("succeeded_by_id")
  succeededAt   DateTime? @map("succeeded_at")

  failedBy   User?     @relation("UserWalletTransactionFailedBy", fields: [failedById], references: [id])
  failedById String?   @map("failed_by_id")
  failedAt   DateTime? @map("failed_at")

  @@index([walletId])
  @@index([type])
  @@index([paymentGatewayId])
  @@index([succeededById])
  @@index([failedById])
  @@map("user_wallet_transactions")
}

enum TransactionType {
  TOPUP
  PURCHASE
  TOPUP_FOR_PURCHASE
}

enum TransactionStatus {
  CREATED
  PENDING
  SUCCEEDED
  FAILED
}

model PaymentGateway {
  id          String   @id
  name        String // name for admin panel
  description String? // description for admin panel
  label       String // label for user interface
  text        String? // additional text for user interface
  metadata    Json     @default("{}")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  order       Int      @default(0)

  userWalletTransactions UserWalletTransaction[]

  @@index([isActive])
  @@map("payment_gateways")
}
