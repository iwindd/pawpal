generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  displayName String
  password    String
  avatar      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userWallets UserWallet[]   @relation("UserWallets")
  orders      Order[]        @relation("OrderUser")
  roles       Role[]         @relation("UserRoles")
  Resources   Resource[]     @relation("ResourceUser")
  carousels   Carousel[]     @relation("CarouselCreatedBy")
  fields      ProductField[] @relation("FieldCreatedBy")

  @@map("users")
}

model Session {
  id        String   @id
  sid       String   @unique
  data      String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sessions")
}

model Role {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users       User[]       @relation("UserRoles")
  permissions Permission[] @relation("RolePermissions")

  @@map("roles")
}

model Permission {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roles Role[] @relation("RolePermissions")

  @@map("permissions")
}

model UserWallet {
  id         String     @id @default(cuid())
  user_id    String
  user       User       @relation("UserWallets", fields: [user_id], references: [id])
  walletType WalletType @default(MAIN)
  balance    Decimal    @db.Decimal(10, 2)
  currency   String     @default("THB")
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  userWalletTransactions UserWalletTransaction[] @relation("UserWalletTransactions")

  @@map("user_wallets")
}

model UserWalletTransaction {
  id             String            @id @default(cuid())
  type           TransactionType   @default(TOPUP)
  wallet_id      String
  wallet         UserWallet        @relation("UserWalletTransactions", fields: [wallet_id], references: [id])
  amount         Decimal           @db.Decimal(10, 2)
  balance_before Decimal           @db.Decimal(10, 2)
  balance_after  Decimal           @db.Decimal(10, 2)
  status         TransactionStatus @default(PENDING)
  currency       String            @default("THB")
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  order          Order?            @relation(fields: [order_id], references: [id])
  order_id       String?

  payment            PaymentGateway? @relation(fields: [payment_gateway_id], references: [id])
  payment_gateway_id String?

  @@index([wallet_id])
  @@index([type])
  @@index([payment_gateway_id])
  @@map("user_wallet_transactions")
}

model PaymentGateway {
  id          String   @id
  name        String // name for admin panel
  description String? // description for admin panel
  label       String // label for user interface
  text        String? // additional text for user interface
  metadata    Json     @default("{}")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  order       Int      @default(0)

  userWalletTransactions UserWalletTransaction[]

  @@index([isActive])
  @@map("payment_gateways")
}

model Category {
  id        String   @id @default(cuid())
  slug      String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[] @relation("ProductCategory")

  @@index([slug])
  @@index([name])
  @@map("categories")
}

model ProductTag {
  id        String         @id @default(cuid())
  slug      String         @unique
  name      String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  type      ProductTagType @default(USER_DEFINED)

  products Product[] @relation("ProductTags")

  @@index([slug])
  @@index([type])
  @@map("product_tags")
}

model ProductField {
  id          String    @id @default(cuid())
  label       String
  placeholder String?
  metadata    Json      @default("{}")
  type        FieldType @default(TEXT)

  creator    User?   @relation("FieldCreatedBy", fields: [creator_id], references: [id])
  creator_id String?

  optional Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order Int @default(0)

  product_id String
  product    Product @relation("ProductFields", fields: [product_id], references: [id])

  orderFields OrderField[] @relation("OrderFields")

  @@map("product_fields")
}

model Product {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category    Category @relation("ProductCategory", fields: [category_id], references: [id])
  category_id String

  productTags ProductTag[]   @relation("ProductTags")
  packages    Package[]      @relation("ProductPackages")
  carousels   Carousel[]     @relation("ProductCarousels")
  fields      ProductField[] @relation("ProductFields")
  image       Resource?      @relation("ProductImage", fields: [image_id], references: [id])
  image_id    String?

  @@index([slug])
  @@index([category_id])
  @@index([createdAt])
  @@map("products")
}

model Package {
  id          String   @id @default(cuid())
  name        String
  price       Decimal  @db.Decimal(10, 2)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  product    Product @relation("ProductPackages", fields: [product_id], references: [id])
  product_id String

  sales         Sale[]         @relation("PackageSales")
  orderPackages OrderPackage[] @relation("OrderPackages")

  @@index([product_id])
  @@index([price])
  @@map("packages")
}

model Sale {
  id           String       @id @default(cuid())
  name         String
  discountType DiscountType @default(PERCENT)
  discount     Decimal      @db.Decimal(10, 2)
  startAt      DateTime
  endAt        DateTime
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  packages Package[] @relation("PackageSales")

  @@index([startAt])
  @@index([endAt])
  @@index([isActive])
  @@index([discountType])
  @@map("sales")
}

model Order {
  id        String      @id @default(cuid())
  user      User        @relation("OrderUser", fields: [user_id], references: [id])
  user_id   String
  total     Decimal     @db.Decimal(10, 2)
  status    OrderStatus @default(PENDING_PAYMENT)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  orderPackages          OrderPackage[]          @relation("OrderPackages")
  orderFields            OrderField[]            @relation("OrderFields")
  userWalletTransactions UserWalletTransaction[]

  @@map("orders")
}

model OrderPackage {
  id         String   @id @default(cuid())
  order      Order    @relation("OrderPackages", fields: [order_id], references: [id])
  order_id   String
  package    Package  @relation("OrderPackages", fields: [package_id], references: [id])
  package_id String
  amount     Int
  price      Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("order_packages")
}

model OrderField {
  id       String       @id @default(cuid())
  order    Order        @relation("OrderFields", fields: [order_id], references: [id])
  order_id String
  field    ProductField @relation("OrderFields", fields: [field_id], references: [id])
  field_id String
  value    String

  @@map("order_fields")
}

model Resource {
  id        String       @id @default(cuid())
  url       String
  type      ResourceType @default(IMAGE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  user    User   @relation("ResourceUser", fields: [user_id], references: [id])
  user_id String

  carousel Carousel[] @relation("CarouselImage")
  products Product[]  @relation("ProductImage")

  @@map("resources")
}

model Carousel {
  id          String         @id @default(cuid())
  title       String
  status      CarouselStatus @default(DRAFT)
  image       Resource       @relation("CarouselImage", fields: [resource_id], references: [id])
  resource_id String
  product     Product?       @relation("ProductCarousels", fields: [product_id], references: [id])
  product_id  String?

  creator    User   @relation("CarouselCreatedBy", fields: [creator_id], references: [id])
  creator_id String

  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("carousels")
}

enum ProductTagType {
  USER_DEFINED
  SYSTEM
}

enum DiscountType {
  PERCENT
  FIXED
}

enum WalletType {
  MAIN
}

enum TransactionType {
  TOPUP
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  PROCESSING
  COMPLETED
  CANCELLED
}

enum ResourceType {
  IMAGE
}

enum CarouselStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum FieldType {
  TEXT
  EMAIL
  SELECT
  PASSWORD
}
